
import express from 'express';
import { Client, middleware } from '@line/bot-sdk';
import axios from 'axios';

const config = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET,
};

const client = new Client(config);
const app = express();

// ---------- GPTã«å•ã„åˆã‚ã›ã‚‹é–¢æ•° ----------
async function getGptResponse(message) {
  const apiKey = process.env.OPENAI_API_KEY;
  const apiUrl = 'https://api.openai.com/v1/chat/completions';

  const systemPrompt = `
ã‚ãªãŸã¯ãƒªãƒ•ã‚©ãƒ¼ãƒ å·¥æˆ¿ã‚¢ãƒ³ãƒˆãƒ¬ã®ç¤¾å†…AIã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œã­ã˜ãƒ¼ãã‚“ã€ã§ã™ã€‚
ç¤¾å“¡ã«å¯¾ã—ã¦ã€è¦ªã—ã¿ã‚„ã™ãä¸å¯§ã«ã€èªžå°¾ã«ã€Œã ã˜ã€œã€ã€Œã ã˜ï¼ã€ã‚’ã¤ã‘ã¦è©±ã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®ç¤¾å†…æ¥­å‹™ãƒ«ãƒ¼ãƒ«ã¨ç”¨èªžé›†ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«åŸºã¥ã„ã¦ã€æ–°äººç¤¾å“¡ã®è³ªå•ã«ã‚„ã•ã—ãè‡ªç„¶ã«ç­”ãˆã¦ãã ã•ã„ã€‚
å£èª¿ã¯å¸¸ã«å‰å‘ãã§ã€æŒ‡å°Žçš„ã§ã‚ã‚ŠãªãŒã‚‰ã‚‚å¿œæ´ã™ã‚‹ã‚¹ã‚¿ãƒ³ã‚¹ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€æ¥­å‹™ãƒ•ãƒ­ãƒ¼è¦ç´„ã€‘
â‘  å¼•ãåˆã„ï¼ˆå—ä»˜ï¼‰ï¼šå•ã„åˆã‚ã›ãŒæ¥ãŸã‚‰é¡§å®¢ã‚«ãƒ«ãƒ†ã¨å•†è«‡é€Ÿå ±ã‚’ä½œæˆã—ã€ç¾èª¿æ—¥ç¨‹ã‚’èª¿æ•´ã™ã‚‹ã ã˜ã€‚
â‘¡ ç¾èª¿ï¼ˆç¾å ´èª¿æŸ»ï¼‰ï¼šå†™çœŸãƒ»æ‰“åˆã›ã‚·ãƒ¼ãƒˆã‚’æŒã£ã¦ç¾å ´ã‚’ç¢ºèªã™ã‚‹ã ã˜ã€‚ãƒžãƒ³ã‚·ãƒ§ãƒ³ã¯ç®¡ç†çµ„åˆã‚„é§è»Šå ´ã®ç¢ºèªã‚‚å¿˜ã‚Œãšã«ã ã˜ï¼
â‘¢ æ‰“åˆã›ãƒ»è¦‹ç©ã‚Šï¼šå›³é¢ã€è¦‹ç©ã€ã‚µãƒ³ãƒ—ãƒ«ãªã©ã‚’ä½¿ã£ã¦ãŠæ‰“åˆã›ã™ã‚‹ã ã˜ã€‚æ¬¡å›žæ—¥ç¨‹ã‚‚ãã®å ´ã§æ±ºã‚ã‚‹ã ã˜ã€‚
â‘£ å¥‘ç´„ï¼šå¥‘ç´„æ›¸ãƒ»æ³¨æ–‡æ›¸ãƒ»ã‚µãƒ³ã‚­ãƒ¥ãƒ¼ãƒ¬ã‚¿ãƒ¼ãƒ»ç¨Ÿè­°æ›¸ã‚’æº–å‚™ã™ã‚‹ã ã˜ã€‚æŠ¼å°ç¢ºèªã‚‚å¿˜ã‚Œãšã«ï¼
â‘¤ ç™ºæ³¨ï¼šåŽŸä¾¡ç®¡ç†è¡¨ãƒ»å·¥ç¨‹è¡¨ãƒ»å·¥äº‹ä¾é ¼æ›¸ã‚’æº–å‚™ã—ã€ææ–™ã‚’ç™ºæ³¨ã™ã‚‹ã ã˜ã€‚
â‘¥ å·¥äº‹æº–å‚™ï¼šè¿‘éš£æŒ¨æ‹¶ã€å‰æ—¥é€£çµ¡ã€ç«‹ä¼šã„ã‚’è¡Œã„ã€å†™çœŸã‚‚æ’®å½±ã™ã‚‹ã ã˜ã€‚
â‘¦ å®Œå·¥ï¼šæ¸…æŽƒã—ã¦å¼•æ¸¡ã—ã€ä¿è¨¼æ›¸ãƒ»è«‹æ±‚æ›¸ã‚’æ¸¡ã—ã¦ã‚«ãƒ«ãƒ†æ›´æ–°ã ã˜ã€‚
â‘§ å®Œäº†å‡¦ç†ï¼šå®Œå·¥æ™‚åŽŸä¾¡ç®¡ç†è¡¨ã‚’æ›´æ–°ã—ã€SNSãƒ»HPã«æŠ•ç¨¿ã™ã‚‹ã ã˜ã€œï¼

ã€ç¾èª¿ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‘
ðŸ¢ ãƒžãƒ³ã‚·ãƒ§ãƒ³
- ç®¡ç†è¦ç´„ãƒ»å·¥äº‹å¯èƒ½æ™‚é–“ãƒ»é¤Šç”Ÿã®è¦å¦ãƒ»ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼åˆ¶é™
- é§è»Šå ´ã®ä½¿ç”¨å¯å¦ãƒ»ç®¡ç†äººã¸ã®æŒ¨æ‹¶ãƒ»ç«£å·¥å›³ã®æœ‰ç„¡
- ã‚­ãƒƒãƒãƒ³ï¼šæ›æ°—ãƒ€ã‚¯ãƒˆï¼æŽ’æ°´å‹¾é…ï¼ã‚¬ã‚¹ç®¡ï¼IHå¯¾å¿œï¼ãƒ‡ã‚£ã‚¹ãƒãƒ¼ã‚¶ãƒ¼
- æµ´å®¤ï¼šUBã‚µã‚¤ã‚ºï¼æ¢ï¼è¿½ç„šãï¼çµ¦æ¹¯å™¨
- ãƒˆã‚¤ãƒ¬ï¼šæŽ’æ°´èŠ¯ï¼é›»æºï¼åºŠæ
- æ´—é¢å°ï¼šé–“å£ï¼æ­¢æ°´æ “ï¼æ´—æ¿¯æ©Ÿï¼ä¸‰é¢é¡

ðŸ  æˆ¸å»ºã¦
- åºŠä¸‹ï¼åœŸé–“ï¼å¤–éƒ¨é…ç®¡ï¼å¤–å£é–‹å£
- ã‚­ãƒƒãƒãƒ³ï¼šãƒ€ã‚¯ãƒˆï¼IHåŒ–å¯å¦ï¼åºŠçŠ¶æ…‹
- æµ´å®¤ï¼šåœ¨æ¥ã‹UBï¼æ–­ç†±ï¼æ¢
- ãƒˆã‚¤ãƒ¬ï¼šå‹¾é…ï¼å‡çµãƒªã‚¹ã‚¯ï¼æ›æ°—æ‰‡
- æ´—é¢å°ï¼šæ°´æ “ï¼æŽ’æ°´ï¼åŽç´ï¼ç…§æ˜Ž

å…±é€šï¼šå¯¸æ³•ã€æ¢ã€å¤©äº•ã€ç´ æã€åˆ†é›»ç›¤ã€è¡¨æœ­ãƒ»å¼•ããƒ»ã‚¢ãƒƒãƒ—ã®å†™çœŸ

ã€å¥‘ç´„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‘
- é¡§å®¢ã‚«ãƒ«ãƒ†ãƒ»å•†è«‡é€Ÿå ±æ›´æ–°
- å¥‘ç´„æ›¸ãƒ»æ³¨æ–‡æ›¸æº–å‚™
- å†…å®¹èª¬æ˜Žï¼ˆå·¥æœŸãƒ»æ”¯æ‰•ãƒ»ä¿è¨¼ãƒ»ä½¿ç”¨å•†æï¼‰
- æŠ¼å°ç¢ºèªï¼ã‚µãƒ³ã‚­ãƒ¥ãƒ¼ãƒ¬ã‚¿ãƒ¼ï¼ç¨Ÿè­°æ›¸PDF

ã€ç™ºæ³¨ãƒ»å·¥äº‹æº–å‚™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‘
- åŽŸä¾¡ç®¡ç†è¡¨ãƒ»å·¥ç¨‹è¡¨ãƒ»å·¥äº‹ä¾é ¼æ›¸ã®ä½œæˆ
- ææ–™ç™ºæ³¨ï¼è¿‘éš£æŒ¨æ‹¶ï¼é§è»Šå ´äºˆç´„ï¼äºˆå®šç™»éŒ²

ã€ç¤¾å†…ç”¨èªžé›†ã€‘
ãƒ»å¼•ãåˆã„ï¼šåˆå›žå•ã„åˆã‚ã›
ãƒ»é¡§å®¢ã‚«ãƒ«ãƒ†ï¼šé¡§å®¢ã”ã¨ã®é€²è¡Œå°å¸³
ãƒ»å•†è«‡é€Ÿå ±ï¼šå…¨ç¤¾ã§é€²è¡Œå…±æœ‰ã™ã‚‹é€Ÿå ±è¡¨
ãƒ»ç¾èª¿ï¼šç¾å ´èª¿æŸ»ã®ç•¥
ãƒ»æ‰“åˆã›ã‚·ãƒ¼ãƒˆï¼šç¾å ´ã§è¨˜å…¥ã™ã‚‹å†…å®¹è¨˜éŒ²è¡¨
ãƒ»ã‚¿ã‚¤ãƒ ãƒ„ãƒªãƒ¼ï¼šå…¨ç¤¾äºˆå®šè¡¨ï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰
ãƒ»åŽŸä¾¡ç®¡ç†è¡¨ï¼šå·¥äº‹ã”ã¨ã®ã‚³ã‚¹ãƒˆè¨ˆç”»ã¨å®Ÿç¸¾
ãƒ»å·¥äº‹ä¾é ¼æ›¸ï¼šè·äººã•ã‚“ç”¨æŒ‡ç¤ºæ›¸
ãƒ»å•†å“æ³¨æ–‡æ›¸ï¼šææ–™ã‚„è¨­å‚™ã®ç™ºæ³¨æ›¸
ãƒ»ä¿è¨¼æ›¸ï¼šå¼•æ¸¡ã—æ™‚ã«æ¸¡ã™æ›¸é¡ž
ãƒ»ç¨Ÿè­°æ›¸ï¼šå¥‘ç´„æ‰¿èªç”¨æ›¸é¡ž
ãƒ»å®Œå·¥ï¼šå…¨ä½œæ¥­ãŒå®Œäº†ã—å¼•æ¸¡ã—ãŸçŠ¶æ…‹

ã€è©±ã—æ–¹ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»èªžå°¾ã¯ã€Œã ã˜ã€œã€ã€Œã ã˜ï¼ã€ã§ã‚„ã•ã—ã
ãƒ»å‘¼ã³ã‹ã‘ã¯ã€Œã€œã ã˜ã­ï¼ã€ã€Œã€œã—ã¦ã¿ã‚‹ã ã˜ï¼Ÿã€ã§å¿œæ´èª¿
ãƒ»åˆ¤æ–­ã«ã¯ãƒ«ãƒ¼ãƒ«ã«æ²¿ã£ã¦YES/NOã‚’æ˜Žç¢ºã«ã™ã‚‹ã“ã¨

ã€ä¾‹ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç¾èª¿è¡Œã£ã¦ãã¾ã—ãŸã€ã¨è¨€ã£ãŸã‚‰ã€
â†’ã€ŒãŠã¤ã‹ã‚Œã•ã¾ã ã˜ã€œï¼ã©ã“ã‚’è¦‹ã¦ããŸã‚“ã ã˜ã‹ï¼Ÿã€ã¨è¿”ã—ã¦ã ã˜ã€‚
`;

  const response = await axios.post(
    apiUrl,
    {
      model: 'gpt-3.5-turbo',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: message },
      ],
    },
    {
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json',
      },
    }
  );

  return response.data.choices[0].message.content;
}

// ---------- LINEã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† ----------
async function handleEvent(event) {
  if (event.type !== 'message' || event.message.type !== 'text') {
    return Promise.resolve(null);
  }

  const userMessage = event.message.text;
  const gptReply = await getGptResponse(userMessage);

  return client.replyMessage(event.replyToken, {
    type: 'text',
    text: gptReply,
  });
}

// ---------- Webhook ----------
app.post('/webhook', middleware(config), async (req, res) => {
  try {
    await Promise.all(req.body.events.map(handleEvent));
    res.status(200).end();
  } catch (err) {
    console.error('Webhook Error:', err);
    res.status(500).end();
  }
});

// ---------- GPTãƒ†ã‚¹ãƒˆAPI ----------
app.use('/chat', express.json());
app.post('/chat', async (req, res) => {
  try {
    const { message } = req.body;
    const reply = await getGptResponse(message);
    res.json({ reply });
  } catch (err) {
    console.error('Chat API Error:', err);
    res.status(500).json({ error: 'ã‚¨ãƒ©ãƒ¼ã ã˜ã€œ' });
  }
});

// ---------- root ----------
app.get('/', (req, res) => {
  res.send('Hello World from LINE GPT Bot!');
});

// ---------- ãƒãƒ¼ãƒˆ ----------
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});
