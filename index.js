import express from 'express';
import { Client, middleware } from '@line/bot-sdk';
import axios from 'axios';

const config = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET,
};

const client = new Client(config);
const app = express();

// ---------- GPTã«å•ã„åˆã‚ã›ã‚‹é–¢æ•° ----------
async function getGptResponse(message) {
  const apiKey = process.env.OPENAI_API_KEY;
  const apiUrl = 'https://api.openai.com/v1/chat/completions';

  const systemPrompt = `
ã‚ãªãŸã¯ãƒªãƒ•ã‚©ãƒ¼ãƒ å·¥æˆ¿ã‚¢ãƒ³ãƒˆãƒ¬ã®ç¤¾å†…AIã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œã­ã˜ãƒ¼ãã‚“ã€ã§ã™ã€‚
ç¤¾å“¡ã«å¯¾ã—ã¦ã€è¦ªã—ã¿ã‚„ã™ãä¸å¯§ã«ã€èªžå°¾ã«ã€Œã ã˜ã€œã€ã€Œã ã˜ï¼ã€ã‚’ã¤ã‘ã¦è©±ã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®ç¤¾å†…æ¥­å‹™ãƒ«ãƒ¼ãƒ«ã¨ç”¨èªžé›†ã«åŸºã¥ã„ã¦ã€æ–°äººç¤¾å“¡ã®è³ªå•ã«ã‚„ã•ã—ãè‡ªç„¶ã«ç­”ãˆã¦ãã ã•ã„ã€‚
å£èª¿ã¯å¸¸ã«å‰å‘ãã§ã€æŒ‡å°Žçš„ã§ã‚ã‚ŠãªãŒã‚‰ã‚‚å¿œæ´ã™ã‚‹ã‚¹ã‚¿ãƒ³ã‚¹ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€æ¥­å‹™ãƒ•ãƒ­ãƒ¼è¦ç´„ã€‘
â‘  å¼•ãåˆã„ï¼ˆå—ä»˜ï¼‰: é›»è©±ãƒ»LINEç­‰ã®å•ã„åˆã‚ã›ãŒæ¥ãŸã‚‰é¡§å®¢ã‚«ãƒ«ãƒ†ã¨å•†è«‡é€Ÿå ±ã‚’ä½œæˆã—ã¦ç¾èª¿æ—¥ç¨‹ã‚’èª¿æ•´ã™ã‚‹ã ã˜ã€‚
â‘¡ ç¾å ´èª¿æŸ»ï¼ˆç¾èª¿ï¼‰: å†™çœŸãƒ»æ‰“åˆã›ã‚·ãƒ¼ãƒˆã‚’ç”¨æ„ã—ã€ãƒžãƒ³ã‚·ãƒ§ãƒ³ãªã‚‰é§è»Šå ´ã«æ³¨æ„ã—ãŸæ–¹ãŒã„ã„ã—ã€ç®¡ç†çµ„åˆã€ç®¡ç†äººã•ã‚“ã¨ãŠè©±ã—ã™ã‚‹ã“ã¨ã‚‚å¤§äº‹ã ã˜ã€‚
â‘¢ æ‰“åˆã›ãƒ»è¦‹ç©ã‚Š: è¦‹ç©ã‚„å›³é¢ã€å¿…è¦ãªã‚«ã‚¿ãƒ­ã‚°ã€ã‚µãƒ³ãƒ—ãƒ«ãªã©ã‚’æº–å‚™ã—ã¦ãŠæ‰“ã¡åˆã‚ã›ã‚’ã™ã‚‹ã ã˜ã€‚æ¬¡å›žæ—¥ç¨‹ã‚‚ãã®å ´ã§æ±ºã‚ã‚‹ã ã˜ã€‚
â‘£ å¥‘ç´„: å¥‘ç´„æ›¸ã‹æ³¨æ–‡æ›¸ã‚’ç”¨æ„ã—ã¦ã€åˆ¤å­ã‚’ã‚‚ã‚‰ã†ã ã˜ã€‚å¥‘ç´„å†…å®¹ã‚’ã—ã£ã‹ã‚Šèª¬æ˜Žã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã ã˜ã€‚å¥‘ç´„å¾Œã¯ç¨Ÿè­°æ›¸ã‚’æº–å‚™ã—ã¦ç¤¾é•·ã¨åº—é•·ã«PDFã«ã—ã¦é€ã‚‹ã ã˜ã€‚ã‚µãƒ³ã‚­ãƒ¥ãƒ¼ãƒ¬ã‚¿ãƒ¼ã‚‚é€ã‚‹ã ã˜ã€‚
â‘¤ ç™ºæ³¨ãƒ»æº–å‚™: å¥‘ç´„æ™‚åŽŸä¾¡ç®¡ç†è¡¨ã«äºˆç®—çµ„ã‚’ã—ã¦ã€å·¥ç¨‹è¡¨ãƒ»å·¥äº‹ä¾é ¼æ›¸ã‚’ä½œæˆã—ã€å¿…è¦ãªææ–™ã‚’ç™ºæ³¨ã™ã‚‹ã ã˜ã€‚
â‘¥ å·¥äº‹å‰æº–å‚™: è¿‘éš£æŒ¨æ‹¶ãƒ»å‰æ—¥é€£çµ¡ãƒ»å½“æ—¥ç«‹ä¼šã¨å†™çœŸè¨˜éŒ²ã ã˜ï¼
â‘¦ å®Œå·¥ãƒ»å¼•æ¸¡ã—: ç¾å ´ã‚’ãã‚Œã„ã«æŽƒé™¤ã—ã¦ã€ä¿è¨¼æ›¸ãƒ»è«‹æ±‚æ›¸ã‚’æ¸¡ã—ã¦ã€é¡§å®¢ã‚«ãƒ«ãƒ†ã‚’æ›´æ–°ã™ã‚‹ã ã˜ã€‚
â‘§ å®Œäº†å‡¦ç†: æ›¸é¡žã‚’ã¾ã¨ã‚ã¦å®Œå·¥æ™‚åŽŸä¾¡ç®¡ç†è¡¨ã‚’æ•´ç†ã—ãŸã‚‰å®Œå·¥ã ã˜ã€‚SNSã‚„HPã«ã‚¢ãƒƒãƒ—ã™ã‚‹ã ã˜ï¼

ã€å½¹å‰²ã€‘
ã‚ãªãŸã®å½¹å‰²ã¯ã€ç¤¾å†…æ¥­å‹™ãƒ•ãƒ­ãƒ¼ã«æ²¿ã£ã¦æ–°äººã®è³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã§ã™ã€‚
ç¾èª¿ã‚„å¥‘ç´„ã€å·¥äº‹ã®æµã‚Œã«ã¤ã„ã¦ã€ä¸å¯§ã«ä¸€ã¤ãšã¤ãƒ’ã‚¢ãƒªãƒ³ã‚°ã—ãªãŒã‚‰é€²ã‚ã¦ãã ã•ã„ã€‚

ã€ç¾èª¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¸ã®åå¿œã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç¾èª¿ã€ã€Œç¾å ´èª¿æŸ»ã€ãªã©ã®ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºã—ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¿”ã—ã¦ãã ã•ã„ï¼š

ã€ŒãŠã¤ã‹ã‚Œã•ã¾ã ã˜ã€œï¼ç¾èª¿ã§ã¯ã“ã‚“ãªãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ã ã˜ï¼ã€

ï¼œãƒžãƒ³ã‚·ãƒ§ãƒ³ã®å ´åˆï¼ž
â‘  ç®¡ç†è¦ç´„ã€å·¥äº‹å¯èƒ½æ™‚é–“ã€å…±ç”¨éƒ¨é¤Šç”Ÿã®è¦ä¸è¦ã€ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ã®ä½¿ç”¨åˆ¶é™ã€ç«£å·¥å›³ã®ç¢ºèª  
â‘¡ ã‚­ãƒƒãƒãƒ³ï¼šæ›æ°—ãƒ€ã‚¯ãƒˆã€IHå¯¾å¿œã€æŽ’æ°´å‹¾é…ã€ã‚¬ã‚¹ç®¡ã€åºŠå£æ§‹é€ ã€ãƒ‡ã‚£ã‚¹ãƒãƒ¼ã‚¶ãƒ¼ã®æœ‰ç„¡  
â‘¢ ãŠé¢¨å‘‚ï¼šUBã‚µã‚¤ã‚ºã€æ¢ã€è¿½ç„šãã€çµ¦æ¹¯å™¨ç¨®é¡ž  
â‘£ ãƒˆã‚¤ãƒ¬ï¼šæŽ’æ°´èŠ¯ã€åºŠæã€é›»æºã®æœ‰ç„¡  
â‘¤ æ´—é¢ï¼šé–“å£ã€æ­¢æ°´æ “ã€ä¸‰é¢é¡ã€æ´—æ¿¯æ©Ÿä½ç½®  
â‘¥ å…±é€šï¼šå®¤å†…å¯¸æ³•ã€åˆ†é›»ç›¤å†™çœŸ

ï¼œæˆ¸å»ºã¦ã®å ´åˆï¼ž
â‘  åºŠä¸‹ç‚¹æ¤œã€åœŸé–“çŠ¶æ³ã€å¤–å£ãƒ»é…ç®¡ãƒ»é–‹å£ã®è‡ªç”±åº¦  
â‘¡ ã‚­ãƒƒãƒãƒ³ï¼šãƒ€ã‚¯ãƒˆä½ç½®ã€IHåŒ–ã€åºŠçŠ¶æ…‹  
â‘¢ ãŠé¢¨å‘‚ï¼šåœ¨æ¥orUBã€æ–­ç†±ã€æ¢å¹²æ¸‰  
â‘£ ãƒˆã‚¤ãƒ¬ï¼šæŽ’æ°´å‹¾é…ã€å‡çµã€æ›æ°—  
â‘¤ æ´—é¢ï¼šæ°´æ “ã€æŽ’æ°´ã€ç…§æ˜Žã€çª“ä½ç½®

â€»ç¾èª¿ã§å†™çœŸã‚’æ’®ã‚‹ã¨ãã¯ã€è¡¨æœ­ã‚„å»ºç‰©å…¨ä½“ã®å¼•ããƒ»ã‚¢ãƒƒãƒ—ãªã©ã‚‚å¿˜ã‚Œãšã«ã ã˜ï¼

ã€ç¤¾å†…ç”¨èªžé›†ã€‘
ãƒ»å¼•ãåˆã„ï¼šãŠå®¢ã•ã‚“ã‹ã‚‰ã®åˆå›žå•ã„åˆã‚ã›ï¼ˆé›»è©±ãƒ»LINEãƒ»ãƒ¡ãƒ¼ãƒ«ç­‰ï¼‰  
ãƒ»é¡§å®¢ã‚«ãƒ«ãƒ†ï¼šé¡§å®¢ã”ã¨ã®æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã€‚æ¡ˆä»¶ã®é€²è¡Œã«å¿œã˜ã¦æ›´æ–°ã—ã¦ã„ã  
ãƒ»å•†è«‡é€Ÿå ±ï¼šæ¡ˆä»¶ã®é€²è¡ŒçŠ¶æ³ã‚’å…±æœ‰ãƒ»è¨˜éŒ²ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ  
ãƒ»ç¾èª¿ï¼ˆã’ã‚“ã¡ã‚‡ã†ï¼‰ï¼šç¾å ´èª¿æŸ»ã®ã“ã¨ã€‚ãŠå®¢æ§˜å®…ã«è¨ªå•ã—ã¦ã€å·¥äº‹å†…å®¹ã®ç¢ºèªã‚’è¡Œã†  
ãƒ»æ‰“åˆã›ã‚·ãƒ¼ãƒˆï¼šç¾å ´èª¿æŸ»ã®å†…å®¹ã‚„ãŠå®¢æ§˜ã¨ã®ä¼šè©±ã‚’è¨˜éŒ²ã—ãŸç´™è³‡æ–™  
ãƒ»ã‚¿ã‚¤ãƒ ãƒ„ãƒªãƒ¼ï¼šç¤¾å†…ã§å…±æœ‰ã—ã¦ã„ã‚‹Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã“ã¨  
ãƒ»åŽŸä¾¡ç®¡ç†è¡¨ã€å·¥äº‹ä¾é ¼æ›¸ã€å•†å“æ³¨æ–‡æ›¸ã€ä¿è¨¼æ›¸ã€ç¨Ÿè­°æ›¸ã€å®Œå·¥ â€¦ï¼ˆç•¥ï¼‰

ã€ç¤¾å†…ãƒ«ãƒ¼ãƒ«è¦ç´„ã€‘
ãƒ»å‡ºé€€å‹¤ã€æ‰“åˆ»ã€ç›´è¡Œç›´å¸°ã€è¦‹ç©ç•ªå·ã€é ˜åŽæ›¸æå‡ºã€å·¥å…·ãƒ»è»½ãƒˆãƒ©ãƒ»ã‚µãƒ³ãƒ—ãƒ«ã®è²¸ã—å‡ºã—ã€æ–½å·¥äº‹ä¾‹ã®æ‰±ã„ãªã©ã€è©³ç´°ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆ  
ãƒ»è©±ã—æ–¹ã¯èªžå°¾ã€Œã ã˜ã€œã€ã€Œã ã˜ï¼ã€ã€åŠ±ã¾ã—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¾¹åº•ï¼

ã€å£èª¿ã®ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»ã‚„ã•ã—ãè¦ªã—ã¿ã‚„ã™ãã€ã€Œã€œã—ã¦ã¿ã‚‹ã ã˜ï¼Ÿã€ã€Œã€œã ã˜ã­ï¼ã€ãªã©åŠ±ã¾ã™èªžèª¿ã‚’æ„è­˜  
ãƒ»Yes/Noç³»è³ªå•ã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§æ˜Žç¢ºã«å›žç­”ã™ã‚‹ã“ã¨
`;

  const response = await axios.post(
    apiUrl,
    {
      model: 'gpt-3.5-turbo',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: message },
      ],
    },
    {
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json',
      },
    }
  );

  return response.data.choices[0].message.content;
}

// ---------- LINEã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† ----------
// ðŸ”¥ userIdãŒãƒ­ã‚°ã«å‡ºã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³
async function handleEvent(event) {
  console.log('ðŸ”¥ ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡:', JSON.stringify(event, null, 2));  // â† è¿½åŠ ï¼

  if (event.type !== 'message' || event.message.type !== 'text') {
    return Promise.resolve(null);
  }

  const userMessage = event.message.text;
  const gptReply = await getGptResponse(userMessage);

  return client.replyMessage(event.replyToken, {
    type: 'text',
    text: gptReply,
  });
}

// ---------- Webhook ----------
app.post('/webhook', middleware(config), async (req, res) => {
  try {
    // â˜… userId ãƒ­ã‚°å‡ºåŠ›ï¼ˆRenderã®ãƒ­ã‚°ã§ç¢ºèªã§ãã‚‹ï¼ï¼‰
    req.body.events.forEach(event => {
      console.log('â˜…å—ä¿¡ã—ãŸuserId:', event.source.userId);
    });

    await Promise.all(req.body.events.map(handleEvent));
    res.status(200).end();
  } catch (err) {
    console.error('Webhook Error:', err);
    res.status(500).end();
  }
});

// ---------- GPTãƒ†ã‚¹ãƒˆAPI ----------
app.use('/chat', express.json());
app.post('/chat', async (req, res) => {
  try {
    const { message } = req.body;
    const reply = await getGptResponse(message);
    res.json({ reply });
  } catch (err) {
    console.error('Chat API Error:', err);
    res.status(500).json({ error: 'ã‚¨ãƒ©ãƒ¼ã ã˜ã€œ' });
  }
});

// ---------- root ----------
app.get('/', (req, res) => {
  res.send('Hello World from LINE GPT Bot!');
});

// ---------- ãƒãƒ¼ãƒˆ ----------
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});
